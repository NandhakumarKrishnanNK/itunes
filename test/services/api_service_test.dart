import 'package:flutter_test/flutter_test.dart';
import 'package:http/http.dart' as http;
import 'package:http/http.dart';
import 'package:http/testing.dart';
import 'package:itunes/src/model/itunes_model.dart';
import 'package:itunes/src/services/api_service.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';

@GenerateMocks([http.Client])
void main() {
  group('ApiService', () {
    test('Fetch ITunes data using http call completes successfully', () async {
      Future<Response> _mockSuccessRequest(Request request) async {
        if (request.url.toString().startsWith(
            'https://itunes.apple.com/search?term=nolan&entity=movie')) {
          return Response(
              '{ "resultCount":4, "results": [ {"wrapperType":"track", "kind":"feature-movie", "trackId":1622724076, "artistName":"Bradley Jackson", "trackName":"Facing Nolan", "trackCensoredName":"Facing Nolan", "trackViewUrl":"https://itunes.apple.com/us/movie/facing-nolan/id1622724076?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video126/v4/45/14/ae/4514ae8d-0d3d-931a-6c63-1fecf7a422fe/mzvf_299535956558634287.640x454.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/100x100bb.jpg", "collectionPrice":14.99, "trackPrice":14.99, "trackRentalPrice":3.99, "collectionHdPrice":14.99, "trackHdPrice":14.99, "trackHdRentalPrice":3.99, "releaseDate":"2022-05-24T07:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":6099813, "country":"USA", "currency":"USD", "primaryGenreName":"Documentary", "contentAdvisoryRating":"NR", "shortDescription":"Nolan Ryan is emblazoned onto our sub-conscience. Images of him pitching with a jersey covered in", "longDescription":"Nolan Ryan is emblazoned onto our sub-conscience. Images of him pitching with a jersey covered in blood, 7 no-hitters, the all-time strikeout record, and the iconic brawl where Nolan walloped Robin Ventura are cultural cornerstones. But Ryan’s career is a study in extremes. He holds the record for most walks and most wild pitches. With this in mind, where does Ryan fit in the game of baseball?"}, {"wrapperType":"track", "kind":"feature-movie", "trackId":527354043, "artistName":"Alan Hruska", "trackName":"Nola", "trackCensoredName":"Nola", "trackViewUrl":"https://itunes.apple.com/us/movie/nola/id527354043?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video118/v4/4a/5c/0b/4a5c0b75-3292-7fdf-f42d-281891bc0c7e/mzvf_4150273532963992942.640x480.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/100x100bb.jpg", "collectionPrice":3.99, "trackPrice":3.99, "trackRentalPrice":3.99, "collectionHdPrice":5.99, "trackHdPrice":5.99, "trackHdRentalPrice":3.99, "releaseDate":"2004-04-02T08:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":5886767, "country":"USA", "currency":"USD", "primaryGenreName":"Comedy", "contentAdvisoryRating":"R", "shortDescription":"The beautiful innocent Nola arrives in New York City like many teenagers before her, with talent and", "longDescription":"The beautiful innocent Nola (EMMY ROSSUM) arrives in New York City like many teenagers before her, with talent and a dream. From the moment she sets foot in Manhattan, her life will never be the same. DEBUT PERFORMANCE OF EMMY ROSSUM"}, {"wrapperType":"track", "kind":"feature-movie", "trackId":529336572, "artistName":"Henry Corra", "trackName":"The Disappearance of McKinley Nolan", "trackCensoredName":"The Disappearance of McKinley Nolan", "trackViewUrl":"https://itunes.apple.com/us/movie/the-disappearance-of-mckinley-nolan/id529336572?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video117/v4/82/ae/d6/82aed620-e5eb-fb13-5c23-33e6e425532f/mzvf_6264084397603773144.640x480.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/100x100bb.jpg", "collectionPrice":7.99, "trackPrice":7.99, "trackRentalPrice":3.99, "collectionHdPrice":9.99, "trackHdPrice":9.99, "trackHdRentalPrice":3.99, "releaseDate":"2010-01-01T08:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":4686272, "country":"USA", "currency":"USD", "primaryGenreName":"Documentary", "contentAdvisoryRating":"NR", "shortDescription":"Private McKinley Nolan vanished forty years ago in Vietnam on the Cambodian frontier. Some say he", "longDescription":"Private McKinley Nolan vanished forty years ago in Vietnam on the Cambodian frontier. Some say he was captured, some say he was a traitor, some even say he was an American operative. The U.S. Army officially claims he was radicalized and \"went native,\" joined the Viet Cong and was later murdered by the Khmer Rouge. In 2006, retired U.S. Army Lt. Dan Smith, revisiting the battlefields of his youth, may have encountered McKinley, alive. So begins a journey into the heart of darkness."}, {"wrapperType":"track", "kind":"feature-movie", "trackId":1218672645, "artistName":"Jean-Luc Annest", "trackName":"Nola Circus", "trackCensoredName":"Nola Circus", "trackViewUrl":"https://itunes.apple.com/us/movie/nola-circus/id1218672645?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video122/v4/0f/ad/25/0fad257c-6cb2-c232-d0b3-a00c69034fb6/mzvf_6286839232000065608.640x354.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/100x100bb.jpg", "collectionPrice":9.99, "trackPrice":9.99, "trackRentalPrice":3.99, "collectionHdPrice":9.99, "trackHdPrice":9.99, "trackHdRentalPrice":3.99, "releaseDate":"2017-04-21T07:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":5353760, "country":"USA", "currency":"USD", "primaryGenreName":"Comedy", "contentAdvisoryRating":"Unrated", "shortDescription":"A rivalry between two competing barbershops on opposite sides of a street in New Orleans escalates", "longDescription":"A rivalry between two competing barbershops on opposite sides of a street in New Orleans escalates dramatically, sending the lives of the owners, their families and their friends spiraling out of control."}] }',
              200);
        }
        return throw Exception('failed');
      }

      final client = MockClient(_mockSuccessRequest);

      final apiService = ApiService();
      when(client.get(Uri.parse(
              'https://itunes.apple.com/search?term=nolan&entity=movie')))
          .thenAnswer((_) async => http.Response(
              '{ "resultCount":4, "results": [ {"wrapperType":"track", "kind":"feature-movie", "trackId":1622724076, "artistName":"Bradley Jackson", "trackName":"Facing Nolan", "trackCensoredName":"Facing Nolan", "trackViewUrl":"https://itunes.apple.com/us/movie/facing-nolan/id1622724076?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video126/v4/45/14/ae/4514ae8d-0d3d-931a-6c63-1fecf7a422fe/mzvf_299535956558634287.640x454.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video126/v4/6b/6e/f9/6b6ef99c-2e69-4907-7f8c-028d27e92b83/FacingNolan_Poster_2000x3000.jpg/100x100bb.jpg", "collectionPrice":14.99, "trackPrice":14.99, "trackRentalPrice":3.99, "collectionHdPrice":14.99, "trackHdPrice":14.99, "trackHdRentalPrice":3.99, "releaseDate":"2022-05-24T07:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":6099813, "country":"USA", "currency":"USD", "primaryGenreName":"Documentary", "contentAdvisoryRating":"NR", "shortDescription":"Nolan Ryan is emblazoned onto our sub-conscience. Images of him pitching with a jersey covered in", "longDescription":"Nolan Ryan is emblazoned onto our sub-conscience. Images of him pitching with a jersey covered in blood, 7 no-hitters, the all-time strikeout record, and the iconic brawl where Nolan walloped Robin Ventura are cultural cornerstones. But Ryan’s career is a study in extremes. He holds the record for most walks and most wild pitches. With this in mind, where does Ryan fit in the game of baseball?"}, {"wrapperType":"track", "kind":"feature-movie", "trackId":527354043, "artistName":"Alan Hruska", "trackName":"Nola", "trackCensoredName":"Nola", "trackViewUrl":"https://itunes.apple.com/us/movie/nola/id527354043?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video118/v4/4a/5c/0b/4a5c0b75-3292-7fdf-f42d-281891bc0c7e/mzvf_4150273532963992942.640x480.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video1/v4/17/08/11/17081162-1506-a613-3917-e4d969b69ec6/mza_2574681259312917954.jpg/100x100bb.jpg", "collectionPrice":3.99, "trackPrice":3.99, "trackRentalPrice":3.99, "collectionHdPrice":5.99, "trackHdPrice":5.99, "trackHdRentalPrice":3.99, "releaseDate":"2004-04-02T08:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":5886767, "country":"USA", "currency":"USD", "primaryGenreName":"Comedy", "contentAdvisoryRating":"R", "shortDescription":"The beautiful innocent Nola arrives in New York City like many teenagers before her, with talent and", "longDescription":"The beautiful innocent Nola (EMMY ROSSUM) arrives in New York City like many teenagers before her, with talent and a dream. From the moment she sets foot in Manhattan, her life will never be the same. DEBUT PERFORMANCE OF EMMY ROSSUM"}, {"wrapperType":"track", "kind":"feature-movie", "trackId":529336572, "artistName":"Henry Corra", "trackName":"The Disappearance of McKinley Nolan", "trackCensoredName":"The Disappearance of McKinley Nolan", "trackViewUrl":"https://itunes.apple.com/us/movie/the-disappearance-of-mckinley-nolan/id529336572?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video117/v4/82/ae/d6/82aed620-e5eb-fb13-5c23-33e6e425532f/mzvf_6264084397603773144.640x480.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video/v4/b4/d5/0c/b4d50c79-49a9-352c-0750-4c39a0ded4cc/mza_2325046057242292356.jpg/100x100bb.jpg", "collectionPrice":7.99, "trackPrice":7.99, "trackRentalPrice":3.99, "collectionHdPrice":9.99, "trackHdPrice":9.99, "trackHdRentalPrice":3.99, "releaseDate":"2010-01-01T08:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":4686272, "country":"USA", "currency":"USD", "primaryGenreName":"Documentary", "contentAdvisoryRating":"NR", "shortDescription":"Private McKinley Nolan vanished forty years ago in Vietnam on the Cambodian frontier. Some say he", "longDescription":"Private McKinley Nolan vanished forty years ago in Vietnam on the Cambodian frontier. Some say he was captured, some say he was a traitor, some even say he was an American operative. The U.S. Army officially claims he was radicalized and \"went native,\" joined the Viet Cong and was later murdered by the Khmer Rouge. In 2006, retired U.S. Army Lt. Dan Smith, revisiting the battlefields of his youth, may have encountered McKinley, alive. So begins a journey into the heart of darkness."}, {"wrapperType":"track", "kind":"feature-movie", "trackId":1218672645, "artistName":"Jean-Luc Annest", "trackName":"Nola Circus", "trackCensoredName":"Nola Circus", "trackViewUrl":"https://itunes.apple.com/us/movie/nola-circus/id1218672645?uo=4", "previewUrl":"https://video-ssl.itunes.apple.com/itunes-assets/Video122/v4/0f/ad/25/0fad257c-6cb2-c232-d0b3-a00c69034fb6/mzvf_6286839232000065608.640x354.h264lc.U.p.m4v", "artworkUrl30":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/30x30bb.jpg", "artworkUrl60":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/60x60bb.jpg", "artworkUrl100":"https://is1-ssl.mzstatic.com/image/thumb/Video52/v4/f5/d0/f7/f5d0f7f1-be62-1d9d-48cd-e7a9135d737e/XL_rator_77-en-US.jpg/100x100bb.jpg", "collectionPrice":9.99, "trackPrice":9.99, "trackRentalPrice":3.99, "collectionHdPrice":9.99, "trackHdPrice":9.99, "trackHdRentalPrice":3.99, "releaseDate":"2017-04-21T07:00:00Z", "collectionExplicitness":"notExplicit", "trackExplicitness":"notExplicit", "trackTimeMillis":5353760, "country":"USA", "currency":"USD", "primaryGenreName":"Comedy", "contentAdvisoryRating":"Unrated", "shortDescription":"A rivalry between two competing barbershops on opposite sides of a street in New Orleans escalates", "longDescription":"A rivalry between two competing barbershops on opposite sides of a street in New Orleans escalates dramatically, sending the lives of the owners, their families and their friends spiraling out of control."}] }',
              200));

      expect(await apiService.getiTunesData(artist: 'nolan', entity: 'movie'),
          isA<ITunesModel>());
    });

    test(
        'ITunes when fetching the data throws an exception if the http call completes with an error',
        () async {
      Future<Response> _mockFailiureRequest(Request request) async {
        if (request.url.toString().startsWith(
            'https://itunes.apple.com/search?term=nolan&entity=ebookss')) {
          return Response(
              '{ "errorMessage":"Invalid value(s) for key(s): [resultEntity]", "queryParameters":{"output":"json", "callback":"A javascript function to handle your search results", "country":"ISO-2A country code", "limit":"The number of search results to return", "term":"A search string", "lang":"ISO-2A language code"} }',
              400);
        }
        return throw Exception('failed');
      }

      final client = MockClient(_mockFailiureRequest);
      final apiService = ApiService();

      when(client.get(Uri.parse(
              'https://itunes.apple.com/search?term=nolan&entity=ebookss')))
          .thenAnswer((_) async => http.Response(
              '{ "errorMessage":"Invalid value(s) for key(s): [resultEntity]", "queryParameters":{"output":"json", "callback":"A javascript function to handle your search results", "country":"ISO-2A country code", "limit":"The number of search results to return", "term":"A search string", "lang":"ISO-2A language code"} }',
              400));

      expect(apiService.getiTunesData(artist: 'nolan', entity: 'ebookss'),
          throwsException);
    });
  });
}
